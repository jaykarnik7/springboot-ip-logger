name: Build and Deploy Spring Boot to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 📦 Checkout repository
      uses: actions/checkout@v4

    - name: ☕ Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: 🛠️ Build with Maven
      run: mvn clean package -DskipTests

    - name: 🚚 Copy .jar to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: target/*.jar
        target: /home/${{ secrets.EC2_USER }}/springboot-app/
        strip_components: 0
        overwrite: true

    - name: 🔁 Restart app on EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 5m
        script: |
          echo "🔪 Killing old Spring Boot process (if any)..."
          pkill -f 'java.*jar' || true
          echo "🌀 Starting new Spring Boot app in tmux..."
          if tmux has-session -t springboot 2>/dev/null; then tmux kill-session -t springboot; fi
          tmux new-session -d -s springboot 'java -jar /home/${{ secrets.EC2_USER }}/springboot-app/target/*.jar > /home/${{ secrets.EC2_USER }}/springboot-app/app.log 2>&1'
          echo "✅ App started in tmux session 'springboot'"

          echo "📄 Recent logs:"
          sleep 5
          tail -n 20 /home/${{ secrets.EC2_USER }}/springboot-app/app.log || echo 'No logs yet.'
