name: Build and Deploy Spring Boot to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v4

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ› ï¸ Build with Maven
      run: mvn clean package -DskipTests

    - name: ğŸšš Copy JAR to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "target/*.jar"
        target: "/home/${{ secrets.EC2_USER }}/springboot-app/"
        strip_components: 1
        overwrite: true

    - name: ğŸ” Deploy with systemd
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 10m
        script: |
          echo "ğŸ” Setting up Spring Boot application with systemd..."
          cd /home/${{ secrets.EC2_USER }}/springboot-app/
          
          # Find the JAR file
          JAR_FILE=$(ls -1 *.jar | head -1)
          if [ -z "$JAR_FILE" ]; then
            echo "âŒ No JAR file found in $(pwd)!"
            ls -la
            exit 1
          fi
          echo "ğŸ“¦ Found JAR file: $JAR_FILE"
          
          # Get the full path to the JAR file
          JAR_PATH="/home/${{ secrets.EC2_USER }}/springboot-app/$JAR_FILE"
          
          # Stop the existing service if it's running
          echo "ğŸ›‘ Stopping existing springboot-app service..."
          sudo systemctl stop springboot-app || echo "Service was not running"
          
          # Create the systemd service file
          echo "ğŸ“ Creating systemd service file..."
          sudo tee /etc/systemd/system/springboot-app.service > /dev/null <<EOF
          [Unit]
          Description=Spring Boot Demo Application
          After=network.target
          Wants=network.target
          
          [Service]
          Type=simple
          User=${{ secrets.EC2_USER }}
          Group=${{ secrets.EC2_USER }}
          WorkingDirectory=/home/${{ secrets.EC2_USER }}/springboot-app
          ExecStart=/usr/bin/java -Xmx512m -Xms256m -Dspring.profiles.active=prod -jar $JAR_PATH
          ExecStop=/bin/kill -15 \$MAINPID
          Restart=always
          RestartSec=10
          KillMode=mixed
          KillSignal=SIGTERM
          TimeoutStopSec=30
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=springboot-app
          
          # Environment variables (if needed)
          Environment=JAVA_HOME=/usr/lib/jvm/java-17-amazon-corretto
          
          [Install]
          WantedBy=multi-user.target
          EOF
          
          # Set proper permissions on the service file
          sudo chmod 644 /etc/systemd/system/springboot-app.service
          
          # Reload systemd daemon to recognize the new service
          echo "ğŸ”„ Reloading systemd daemon..."
          sudo systemctl daemon-reload
          
          # Enable the service to start on boot
          echo "âš¡ Enabling service to start on boot..."
          sudo systemctl enable springboot-app
          
          # Start the service
          echo "ğŸš€ Starting springboot-app service..."
          sudo systemctl start springboot-app
          
          # Wait a moment for the service to start
          echo "â³ Waiting for service to start..."
          sleep 15
          
          # Check service status
          echo "ğŸ“Š Service status:"
          sudo systemctl status springboot-app --no-pager -l
          
          # Show recent logs
          echo "ğŸ“„ Recent application logs:"
          sudo journalctl -u springboot-app -n 20 --no-pager
          
          # Test if the application is responding
          echo "ğŸŒ Testing application health..."
          sleep 5
          
          # Test the health endpoint
          if curl -f -s http://localhost:8080/actuator/health > /dev/null; then
            echo "âœ… Health check passed - Application is running!"
          else
            echo "âš ï¸  Health check failed - Testing main endpoint..."
            # Try a simple curl to see if the app is at least responding
            if curl -f -s -o /dev/null http://localhost:8080/; then
              echo "âœ… Application is responding on port 8080"
            else
              echo "âŒ Application is not responding. Check logs above."
              echo "ğŸ” Process status:"
              ps aux | grep java || echo "No Java processes found"
              echo "ğŸ” Port status:"
              sudo netstat -tlnp | grep 8080 || echo "Port 8080 not in use"
            fi
          fi
          
          echo "ğŸ¯ Deployment complete!"
          echo "ğŸ“‹ Useful commands for managing the service:"
          echo "  sudo systemctl status springboot-app     # Check status"
          echo "  sudo systemctl restart springboot-app    # Restart service"
          echo "  sudo systemctl stop springboot-app       # Stop service"
          echo "  sudo journalctl -u springboot-app -f     # Follow logs"